#!/usr/bin/env -S node --no-warnings --stack-trace-limit=1000

require("events").EventEmitter.defaultMaxListeners = 0

const { cli, dbug } = require("@foundernetes/blueprint")
const cliMachines = require("@foundernetes/cli-machines")

dbug.registerGlobal()

const playbooks = require("~/playbooks")

const loadLocalConfig = require("./.foundernetesrc")

const main = async () => {
  const config = await loadLocalConfig()

  await cli(process.argv, {
    inlineConfigs: [config],
    playbookSet: {
      playbooks,
    },
    cliPlugins: [
      cliMachines({
        cwd: "/home/j/.metal-debian",
        extraUpload: [
          {
            source: `${process.cwd()}/metal-debian.yaml`,
            target: "metal-debian.yaml",
          },
          {
            source: `${__dirname}/dist-bin/metal-debian`,
            target: "metal-debian",
          },
        ],
        extraCommands: [
          {
            command: "sudo ~/.metal-debian/metal-debian",
            logWrap: false,
          },
        ],
      }),
    ],
  })
}

main()
